#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
凡人小说claim提取逻辑提示词模板
用于提取小说文本中的论点、观点、主张
"""

from src.models import PromptTemplate

# 凡人claim提取系统提示词模板
FANREN_CLAIM_EXTRACTION_SYSTEM_TEMPLATE = PromptTemplate.create_template(
    template_key="FANREN_CLAIM_EXTRACTION_SYSTEM_TEMPLATE",
    version="1.0.0",
    description="凡人小说陈述性事实提取系统提示词 - 专门提取事实陈述，不提取实体",
    template_content="""# DOMAIN
修仙小说陈述性事实分析 - 从《凡人修仙传》等修仙小说文本中提取具有叙事价值的核心事实陈述，构建完整的故事发展脉络。

# GOAL
你的目标是从给定的修仙小说文本中，提取所有对理解故事发展有价值的陈述性事实。重点关注实力体系变化、资源流转、关系网络、身份认知、战斗过程和叙事功能。

# 重要说明
- 本模块专门负责提取**事实陈述**（claims），不负责提取实体（entities）
- 实体提取由其他专门的智能模块处理，用户输入会提供已识别的实体列表作为参考
- 每个事实陈述中包含subject字段用于标注涉及的主要实体，应优先使用用户提供的实体列表中的实体名称

# INSTRUCTIONS
1. **事实识别**: 精确识别并提取所有属于规定事实类型的重要陈述性事实。为每个事实提供简洁的描述，捕捉其在修仙世界观中的关键特征和剧情重要性。

2. **分类处理**: 根据事实的性质将其归类到合适的类型中。同一个事件可能涉及多个类型的事实，需要分别提取。

3. **关系链接**: 识别事实之间的关联性，特别是因果关系和时序关系。

4. **输出格式: 严格有效的JSON**: 输出必须是严格有效的JSON格式。遵循所有标准JSON规则。JSON必须包含一个顶级对象，该对象包含"claims"列表。每个claim项必须是具有必需字段的JSON对象，所有字段都必须是用双引号包围的JSON字符串。**绝对不允许使用单引号、方括号包围字符串、尾随逗号或markdown格式（如三个反引号）。** 无效的JSON输出是不可接受的。

# 10类核心事实类型说明

类型F1：能力获得/提升
定义：角色学会新技能或现有能力升级
子类型：
  F1.1 功法习得 - 学会新功法或功法升级
  F1.2 神通领悟 - 掌握新的神通技能
  F1.3 境界突破 - 修为境界晋升
  F1.4 秘术掌握 - 学会特殊秘术
  F1.5 战技提升 - 战斗技巧优化
提取标准：
  必须提取：首次学会、明确升级、有具体能力名称或境界名称
  不要提取：重复使用已有技能、模糊的"实力增强"
示例：
  韩立练气13层突破至筑基初期（F1.3）
  韩立领悟剑意神通（F1.2）
  韩立将《大衍诀》修炼至第三层（F1.1）

---

类型F2：资源获得/损失
定义：物质财富的增减变化
子类型：
  F2.1 法宝获得 - 得到新法宝
  F2.2 法宝升级 - 法宝品质提升
  F2.3 法宝损毁 - 法宝被破坏
  F2.4 灵兽收服 - 收服/培养灵兽
  F2.5 材料获取 - 得到炼器/炼丹材料
  F2.6 丹药炼制 - 成功炼制丹药
  F2.7 资源消耗 - 重大资源消耗
提取标准：
  必须提取：新增/损失/升级的资源、有具体物品名称、品阶、数量
  不要提取：日常消耗、普通材料、模糊描述
示例：
  韩立从储物袋中获得青竹蜂云剑（上品法器）（F2.1）
  元罡盾在激战中碎裂（F2.3）
  韩立收服12只成熟体噬金虫（F2.4）

---

类型F3：关系建立/变化
定义：角色间社交关系的确立或转变
子类型：
  F3.1 结仇 - 与他人/势力结下仇怨
  F3.2 结盟 - 建立合作关系
  F3.3 师徒 - 建立师徒关系
  F3.4 情感 - 情感关系变化
  F3.5 背叛 - 关系破裂
  F3.6 恩情 - 施恩或受恩
提取标准：
  必须提取：关系的建立或明确转变、有双方实体和关系类型
  不要提取：一次性接触、普通交流
示例：
  韩立与血刀门结下死仇，因击杀其三名弟子（F3.1）
  韩立与南宫婉达成合作，共同探索坠魔谷（F3.2）
  韩立拜李化元为师（F3.3）

---

类型F4：身份揭示/变化
定义：角色真实身份或地位的暴露/改变
子类型：
  F4.1 真实身份 - 隐藏身份暴露
  F4.2 境界暴露 - 真实修为暴露
  F4.3 势力归属 - 加入或脱离势力
  F4.4 称号获得 - 获得江湖称号
  F4.5 身份伪装 - 主动伪装身份
提取标准：
  必须提取：身份信息的首次揭示或改变、有明确的身份内容和知情范围
  不要提取：公开信息的重复、临时伪装
示例：
  血刀门长老发现韩立拥有成熟体噬金虫（F4.2）
  韩立加入天星城商盟成为客卿长老（F4.3）
  韩立伪装成散修混入拍卖会（F4.5）

---

类型F5：目标设定/完成
定义：角色确立目标或完成既定目标
子类型：
  F5.1 短期目标 - 近期计划（当前章节可见的目标）
  F5.2 长期目标 - 远期愿景（需要很多章节才能完成）
  F5.3 目标完成 - 成功达成目标
  F5.4 目标失败 - 未能达成目标
  F5.5 目标变更 - 改变原定计划
提取标准：
  必须提取：有明确的目标内容、完成/失败要说明是什么目标
  不要提取：模糊的想法、无计划的行动
示例：
  韩立决定前往坠魔谷寻找千年灵芝（F5.1）
  韩立立志飞升灵界（F5.2）
  韩立成功炼制出筑基丹（F5.3）

---

类型F6：危机/转折
定义：情节的重大转折点
子类型：
  F6.1 生死危机 - 面临致命威胁
  F6.2 意外机缘 - 获得意外好处
  F6.3 计划破产 - 原定计划失败
  F6.4 真相揭露 - 重要信息暴露
  F6.5 局势逆转 - 形势突然改变
提取标准：
  必须提取：对情节有重大影响的事件、有明确的转折内容和影响
  不要提取：日常波折、小摩擦
示例：
  韩立被元婴修士追杀，陷入生死危机（F6.1）
  韩立在洞府中意外发现上古传承（F6.2）
  拍卖会上宝物被他人抢先拍走（F6.3）

---

类型F7：伏笔标记
定义：当前章节埋下的可能在后续章节产生影响的信息
子类型：
  F7.1 物品伏笔 - 获得但未使用的物品
  F7.2 信息伏笔 - 听说但未验证的信息
  F7.3 承诺伏笔 - 做出的承诺或约定
  F7.4 威胁伏笔 - 潜在的威胁或隐患
提取标准：
  必须提取：明确提到但未立即产生作用的内容
  不要提取：立即使用的物品、立即验证的信息
注意：这是单章节可提取的伏笔，不需要跨章节对比
示例：
  韩立获得一枚不知名的古怪玉简（F7.1）
  听闻坠魔谷深处有上古传送阵（F7.2）
  韩立答应三年后帮助南宫婉（F7.3）

---

类型F8：世界观信息
定义：修仙世界的设定信息
子类型：
  F8.1 境界体系 - 修炼等级划分
  F8.2 势力格局 - 各方势力分布
  F8.3 地理设定 - 地域、秘境信息
  F8.4 历史背景 - 过去的重大事件
  F8.5 规则设定 - 世界运行规则
提取标准：
  必须提取：首次出现的设定信息、对理解世界观有帮助
  不要提取：重复信息、无关设定
示例：
  修仙界分为练气、筑基、金丹、元婴、化神五大境界（F8.1）
  天南地区有七大修仙门派（F8.2）
  坠魔谷是上古战场遗迹（F8.3）

---

类型F9：战斗过程
定义：完整战斗的关键节点
子类型：
  F9.1 生死搏杀 - 你死我活的战斗
  F9.2 切磋比试 - 点到为止的较量
  F9.3 群体战争 - 多方势力混战
  F9.4 围攻/被围 - 以多打少
  F9.5 偷袭暗杀 - 隐蔽攻击
  F9.6 追逃战 - 追击或逃跑
  F9.7 守城/攻城 - 据点攻防
提取标准：
  必须提取：完整的战斗过程（有起因、过程、结果）
  不要提取：3句话内结束的小冲突
战斗必须包含的信息：
  1. 参与者：己方 vs 敌方（姓名+境界）
  2. 实力对比：优势/劣势/均势
  3. 战斗起因：为何开打
  4. 关键过程：试探阶段、转折点、底牌使用
  5. 战斗手段：使用的功法/法宝/灵兽/符箓
  6. 战斗结果：胜负+伤亡+战利品+消耗
  7. 后续影响：是否导致结仇、身份暴露等
示例：
  韩立（筑基后期）vs 血刀门长老（假丹期）+2弟子（筑基初期）
  起因：争夺千年灵芝
  过程：青竹蜂云剑试探→被逼入绝境→放出噬金虫
  结果：击杀2弟子，长老血遁逃离，获得储物袋×2
  影响：与血刀门结仇、噬金虫底牌暴露

---

类型F10：探索冒险
定义：进入未知区域的经历
子类型：
  F10.1 秘境探索 - 进入上古遗迹/洞府
  F10.2 险地历练 - 进入危险区域修炼
  F10.3 寻宝夺宝 - 争夺特定宝物
  F10.4 任务委托 - 接受他人委托
  F10.5 意外遭遇 - 非计划内的遭遇
提取标准：
  必须提取：进入新地点或遭遇新事件、有地点、目的、遭遇、结果
  不要提取：日常活动、已知地点的重复访问
示例：
  韩立进入上古修士洞府，发现传承玉简和噬金虫卵（F10.1）
  韩立深入坠魔谷寻找灵药，遭遇六级妖兽（F10.2）

# 示例输入数据
已识别实体参考:
- 韩立 [character]: 修仙小说的主角，资质平凡但意志坚定
- 筑基丹 [item]: 用于冲击筑基境界的丹药
- 筑基初期 [state]: 修仙境界等级之一

文档: "韩立服下筑基丹后，立刻盘膝坐下开始冲击筑基期。三个月后，他终于成功突破，从练气13层晋升为筑基初期修士。突破后，他发现丹田中凝聚出一颗金色的筑基道基。"

# 示例输出数据 (有效JSON - 不得偏离)
{{
  "claims": [
    {{"category": "能力获得/提升", "subject": "韩立", "content": "韩立从练气13层突破至筑基初期"}},
    {{"category": "资源获得/损失", "subject": "韩立", "content": "韩立消耗筑基丹用于突破境界"}}
  ]
}}""",
    required_params=[],
    language="zh",
    notes="基于JSON格式的陈述性事实提取系统提示词"
)

# 凡人claim提取用户提示词模板
FANREN_CLAIM_EXTRACTION_PROMPT_TEMPLATE = PromptTemplate.create_template(
    template_key="FANREN_CLAIM_EXTRACTION_PROMPT_TEMPLATE",
    version="1.0.0",
    description="凡人小说陈述性事实提取用户提示词",
    template_content="""**重要的JSON格式规则:**
- **按照示例输出包含所有识别事实的严格有效JSON。**
- **不要使用方括号或单引号 `(}},],')` 来包围JSON中的字符串。**
- **确保列表或对象中没有尾随逗号。**
- **输出必须是单个有效的JSON对象。不要用三个反引号或任何其他markdown格式包装JSON输出。**

# 已识别实体参考
{entities_info}

# 输入数据
<<DOCUMENT_START>>
**文档**:
{input_text}
<<DOCUMENT_END>>

输出:""",
    required_params=["entities_info", "input_text"],
    language="zh",
    notes="用户提示词模板，用于陈述性事实提取请求，包含实体信息和原文"
)